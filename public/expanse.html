<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VT Expanse Tracker</title>
    <link rel="icon" href="./logo.png">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 CDN for attractive alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Luxon CDN for date/time handling -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <!-- AOS (Animate On Scroll) CSS -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- jsPDF and html2canvas for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
            margin: 0;
            padding: 0;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem; /* Default padding for larger screens */
        }
        
         /* .header-container {
            width: auto;
            /* display: flex; */
            /* justify-content: center;
            align-items: center;
            flex-wrap: wrap; */
            /* margin-bottom: 30px; */
            /* padding: 0 20px; 
        }  */
        
        @media (min-width: 768px) {
            .header-container {
                justify-content: flex-start;
            }
        }
        
        .logo {
            display: flex;
            max-width: 170px;
            height: auto;
            margin-bottom: 0;
            padding-left: 60px;
            justify-content: center;
            align-items: center;

        }

        h2 {
            font-size: 1.5rem; /* 2xl */
            font-weight: 700; /* bold */
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem; /* mb-4 */
        }

        h3 {
            font-size: 1.125rem; /* lg */
            font-weight: 600; /* semibold */
            color: #374151; /* gray-700 */
        }

        /* Card Styles - now with Glassy View */
        .card {
            background-color: rgba(255, 255, 255, 0.6); /* White with transparency */
            backdrop-filter: blur(10px); /* Glass effect */
            border: 1px solid rgba(255, 255, 255, 0.18); /* Subtle white border */
            border-radius: 10px; /* Slightly more rounded */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Glassy shadow */
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease-in-out; /* Smooth transitions */
        }
        .card:hover {
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.45); /* Slightly more pronounced hover shadow */
        }


        /* Form Elements */
        .form-field-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Default to left-align for small screens */
            width: 100%; /* Ensure the group takes full width of its grid column */
        }

        input[type="text"],
        input[type="number"],
        select {
            display: block;
            width: 100%; /* Take full width of parent .form-field-group */
            border: 1px solid #d1d5db; /* border-gray-300 */
            padding: 0.75rem 1rem; /* Increased padding for better look */
            border-radius: 0.5rem; /* rounded-md */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04); /* Subtle initial shadow */
            transition: all 0.2s ease-in-out; /* Smooth transitions */
            background-color: rgba(255, 255, 255, 0.8); /* Slightly transparent background for inputs */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.3); /* More prominent focus ring */
            background-color: #ffffff; /* Solid white on focus */
        }

        input[readonly] {
            background-color: #e5e7eb; /* bg-gray-100 */
            cursor: not-allowed;
            box-shadow: none; /* No shadow for readonly */
        }

        label {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #374151; /* gray-700 */
            margin-bottom: 0.25rem; /* Small gap between label and input */
            width: 100%; /* Ensure label also takes full width for alignment */
            text-align: left; /* Align label text to the left */
            box-sizing: border-box; /* Include padding in width calculation */
        }

        /* Buttons */
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
            transform: translateY(-2px); /* Slight lift effect */
        }
        .btn-primary:active {
            transform: translateY(0); /* Press effect */
        }

        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
            transform: translateY(-1px);
        }
        .btn-danger:active {
            transform: translateY(0);
        }

        /* Tab Buttons */
        .tab-buttons-container {
            display: flex;
            justify-content: center;
            gap: 1rem; /* space-x-4 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .tab-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .tab-button:hover:not(.active) {
            background-color: #d1d5db; /* gray-300 */
        }

        /* Section Spacing & Headings */
        .table-section {
            margin-bottom: 1.5rem;
        }
        .table-section h2 {
            margin-bottom: 0.5rem; /* Reduced gap to table */
            padding: 1rem 1.5rem; /* Padding for the heading itself */
            background-color: #ffffff; /* White background for the heading */
            border-top-left-radius: 0.75rem; /* Rounded top corners */
            border-top-right-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow for heading */
            border-bottom: 1px solid #e5e7eb; /* Separator line below heading */
            display: flex; /* To align icon and text */
            align-items: center;
            color: #1f2937; /* Dark gray text */
            font-size: 1.5rem; /* 2xl */
            font-weight: 700; /* bold */
        }
        .table-section h2 i {
            margin-right: 0.5rem; /* Space for icon */
            color: #6366f1;
        }

        /* Table Styles (General Attractive) */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0; /* Remove default table margin to connect with heading */
            background-color: #ffffff; /* White background for tables */
            border-bottom-left-radius: 0.75rem; /* Rounded bottom corners */
            border-bottom-right-radius: 0.75rem;
            overflow: hidden; /* Ensures rounded corners clip content */
            box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.1), 0 4px 8px -2px rgba(0, 0, 0, 0.06); /* Enhanced shadow */
        }
        th, td {
            padding: 0.85rem 1.1rem; /* Increased padding for better spacing */
            text-align: left;
            border-bottom: 1px solid #e5e7eb; /* Light gray border */
        }
        th {
            background-color: #f9fafb; /* Lighter header background */
            font-weight: 600;
            color: #4b5563; /* Darker gray text */
            text-transform: uppercase; /* Make headers uppercase */
            font-size: 0.875rem; /* Smaller header font */
        }
        tr:hover {
            background-color: #f3f4f6; /* Light gray hover effect for table rows */
        }
        .overflow-x-auto {
            overflow-x: auto; /* Ensures horizontal scrolling for tables on small screens */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }

        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 400px; /* Default height for charts */
            width: 100%;
        }
        /* Charts are now directly within a grid, removing card styling from them */
        .chart-item { /* New class for individual chart containers */
            padding: 0; /* Removed padding to let charts fill space */
            margin-bottom: 1.5rem; /* Maintain margin for spacing within grid */
            background-color: transparent; /* Changed to transparent */
            border: none; /* Removed border */
            box-shadow: none; /* Removed shadow */
            border-radius: 0; /* Removed border-radius */
        }
        .chart-item h2 { /* Style for chart headings */
            margin-bottom: 1rem;
            padding: 1rem 0; /* Adjusted padding to remove side padding */
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: left; /* Ensure heading text aligns left */
            justify-content: flex-start; /* Align icon and text to start */
        }
        .chart-item h2 i {
            margin-right: 0.5rem;
            color: #6366f1;
        }


        /* Utility Classes (replicated from Tailwind concepts) */
        .flex-end {
            display: flex;
            justify-content: flex-end;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .font-medium {
            font-weight: 500;
        }
        .text-gray-700 {
            color: #374151;
        }
        .text-indigo-500 {
            color: #6366f1;
        }
        .mr-2 {
            margin-right: 0.5rem;
        }
        .mr-3 {
            margin-right: 0.75rem;
        }
        .mr-1 {
            margin-right: 0.25rem;
        }
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        .mt-6 {
            margin-top: 1.5rem;
        }
        .mb-4 {
            margin-bottom: 1rem;
        }
        .hidden {
            display: none;
        }
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .font-semibold {
            font-weight: 600;
        }
        .text-red-600 {
            color: #dc2626;
        }
        .text-green-600 {
            color: #16a34a;
        }
        .text-gray-600 {
            color: #4b5563;
        }
        .w-full {
            width: 100%;
        }
        /* New Profile Dropdown Styles */
        .profile-dropdown-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }
        .profile-dropdown-button {
            background-color: #4f46e5;
            color: white;
            border-radius: 9999px; /* A lot of rounded corners to make it round */
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out;
        }
        .profile-dropdown-button:hover {
            transform: scale(1.05);
        }
        .profile-dropdown-menu {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 0.5rem;
            background-color: #fff;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
            z-index: 100;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .profile-dropdown-menu.visible {
            display: flex;
        }
        .profile-name {
            font-weight: 600;
            padding: 0.5rem 1rem;
            color: #1f2937;
            border-bottom: 1px solid #e5e7eb;
        }
        .profile-dropdown-menu .logout-button {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            background-color: #ef4444;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }
        .logout-button i {
            margin-right: 0.5rem;
        }
        
        .pdf-download-message {
            position: fixed;
            bottom: 60px;
            right: 1rem;
            z-index: 999;
            background-color: #4f46e5;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .pdf-download-message.show {
            display: block;
            opacity: 1;
        }
        
        /* Responsive Grid System (Custom Media Queries) */
        .grid {
            display: grid;
            gap: 1.5rem; /* default gap */
        }

        /* Mobile (default: 1 column) */
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        /* Extra small screens (<= 320px) - specific adjustments for very narrow viewports */
        @media (max-width: 320px) {
            .container {
                padding: 0.5rem; /* 8px padding on sides for empty space */
            }
            .header-container {
                padding: 0 0.5rem;
            }
            .logo {
                max-width: 150px;
            }
            h2 {
                font-size: 1.1rem; /* Smaller sub-heading */
                margin-bottom: 0.5rem; /* Reduced margin */
            }
            .card {
                padding: 0.8rem; /* Reduce card padding */
                margin-bottom: 0.8rem; /* Reduced margin */
            }
            /* Form input and label alignment for very small screens */
            .form-field-group {
                align-items: flex-start; /* Align labels and inputs to the left */
            }
            input[type="text"],
            input[type="number"],
            select,
            label {
                max-width: 100%; /* Ensure they take full width */
                box-sizing: border-box; /* Include padding in width */
            }
            input[type="text"],
            input[type="number"],
            select {
                padding: 0.5rem 0.75rem; /* Slightly reduced input padding */
                font-size: 0.875rem; /* Smaller font size for inputs */
            }
            label {
                font-size: 0.8rem; /* Smaller font size for labels */
                margin-bottom: 0.15rem; /* Reduced gap */
            }
            .btn-primary, .btn-danger {
                padding: 0.6rem 1rem; /* Adjust button padding */
                font-size: 0.875rem; /* Smaller button font */
            }
            .tab-button {
                padding: 0.6rem 0.8rem; /* Adjust tab button padding */
                font-size: 0.8rem;
            }
            /* Table specific adjustments for very small screens */
            .table-section h2 {
                font-size: 1.1rem; /* Smaller heading for table sections */
                padding: 0.8rem 1rem;
                margin-bottom: 0.4rem;
            }
            table {
                box-shadow: 0 4px 8px -2px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Smaller shadow */
            }
            th, td {
                padding: 0.5rem 0.7rem; /* Reduce table cell padding */
                font-size: 0.7rem; /* Smaller font for table content */
            }
            th {
                font-size: 0.65rem; /* Even smaller for table headers */
            }
            /* Adjust top-spending-table specifics for very small screens */
            #top-spending-table .item-icon {
                width: 1.8rem; /* Smaller icon */
                height: 1.8rem;
                font-size: 0.8rem;
                margin-right: 0.4rem;
            }
            #top-spending-table .item-name {
                font-size: 0.85rem;
            }
            #top-spending-table .item-category {
                font-size: 0.65rem;
            }
            #top-spending-table .item-amount {
                font-size: 0.9rem;
            }
            #top-spending-table .item-date {
                font-size: 0.6rem;
            }
            #top-spending-table tbody tr {
                padding: 0.6rem 0.8rem; /* Adjusted padding for stacked view */
            }
            .chart-container {
                height: 250px; /* Make charts a bit shorter on very small screens */
            }
            /* Chart items should not have card padding on very small screens */
            .chart-item {
                padding: 0.8rem; /* Match card padding for consistency */
            }
            .chart-item h2 { /* Adjust chart heading padding for 300px */
                padding: 0.8rem 0; /* Remove side padding for heading */
                font-size: 1.1rem;
            }
            .profile-dropdown-button {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            .profile-dropdown-menu {
                min-width: 160px;
            }
            .profile-name {
                font-size: 0.9rem;
            }
            .profile-dropdown-menu .logout-button {
                font-size: 0.9rem;
            }
            .logo {
                max-width: 150px;
            }
        }

        /* Medium screens (>= 468px) - for form inputs, comparison, charts */
        @media (min-width: 468px) {
            .md-grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .md-col-span-2 {
                grid-column: span 2 / span 2;
            }
            .md-w-1-2 {
                width: 50%;
            }
            /* Form inputs take full width of their grid column on medium screens */
            .form-field-group input,
            .form-field-group select,
            .form-field-group label {
                max-width: 100%;
            }
            /* Align form fields to the left within their grid column on medium screens */
            .form-field-group {
                align-items: flex-start;
            }
        }

        /* Tablet Landscape / Small Desktop (>= 760px) - for main table sections */
        @media (min-width: 760px) {
            .lg-grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .lg-col-span-2 {
                grid-column: span 2 / span 2;
            }
            /* Reintroduce max-width for form inputs on larger screens */
            .form-field-group input,
            .form-field-group select,
            .form-field-group label {
                max-width: 85%; /* Apply 85% width from this breakpoint upwards */
            }
            /* Center form fields again for larger screens */
            .form-field-group {
                align-items: center;
            }
        }

        /* Larger Desktop (>= 1024px) - for charts to align in 3 columns */
        @media (min-width: 1024px) {
            .xl-grid-cols-3 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        /* Charts grid for screens >= 760px, but below 1024px */
        @media (min-width: 760px) and (max-width: 1023px) {
            .charts-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns for charts on tablets */
            }
        }
        /* Default charts grid for mobile */
        .charts-grid {
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* 1 column by default */
        }


        /* --- Google Pay Style for Top Spending Items --- */
        #top-spending-table {
            background-color: transparent; /* No background for the table itself */
            border-radius: 0; /* No border-radius for the table */
            box-shadow: none; /* No shadow for the table */
            overflow: visible; /* Allow content to overflow if needed for effects */
        }
        #top-spending-table thead {
            display: none; /* Hide table headers for Google Pay style */
        }
        #top-spending-table tbody tr {
            display: flex;
            align-items: center; /* Align items vertically in the center */
            justify-content: space-between; /* Space out icon/details and amount/date */
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease-in-out;
            width: 100%; /* Ensure row takes full width of its container */
            box-sizing: border-box; /* Include padding in width calculation */
            background-color: #ffffff; /* White background for each row item */
            border-radius: 0.5rem; /* Rounded corners for each row item */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Subtle shadow for each row item */
            margin-bottom: 0.5rem; /* Space between items */
        }
        #top-spending-table tbody tr:hover {
            background-color: #f3f4f6;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Slightly more pronounced shadow on hover */
        }
        #top-spending-table tbody tr:last-child {
            border-bottom: none; /* No border for the last item */
        }

        #top-spending-table tbody td {
            border-bottom: none; /* Remove individual cell borders */
            padding: 0; /* Reset padding for flex layout */
            display: flex; /* Make td a flex container */
            align-items: center; /* Vertically align content within td */
        }
        /* First td (transaction details) */
        #top-spending-table tbody tr td:first-child {
            flex-grow: 1; /* Allow it to grow */
            flex-basis: 60%; /* Give it a base width */
            min-width: 0; /* Allow content to shrink */
            overflow: hidden; /* Ensure text ellipsis works */
        }
        /* Second td (amount and date) */
        #top-spending-table tbody tr td:last-child {
            flex-grow: 0; /* Don't allow it to grow */
            flex-shrink: 0; /* Don't allow it to shrink */
            flex-basis: 40%; /* Give it a base width */
            justify-content: flex-end; /* Push content to the right */
        }


        #top-spending-table .item-icon {
            flex-shrink: 0; /* Don't shrink icon */
            width: 2.5rem; /* Fixed width for icon container */
            height: 2.5rem; /* Fixed height */
            background-color: #e0e7ff; /* light indigo background */
            color: #4f46e5; /* indigo text */
            border-radius: 50%; /* Circular icon */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-right: 0.75rem;
        }

        #top-spending-table .item-details {
            flex-grow: 1; /* Take up remaining space */
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0; /* Allow text to truncate */
            overflow: hidden; /* Ensure text ellipsis works */
        }

        #top-spending-table .item-name {
            font-weight: 600; /* Semibold */
            color: #1f2937; /* Darker text */
            font-size: 1rem;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
        }

        #top-spending-table .item-category {
            font-size: 0.8rem; /* Smaller font */
            color: #6b7280; /* Gray text */
            text-transform: capitalize; /* Capitalize category */
        }

        #top-spending-table .item-amount-date {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Align amount and date to the right */
            /* margin-left: 1rem; Removed as parent td controls spacing */
            flex-shrink: 0; /* Don't shrink amount/date */
        }

        #top-spending-table .item-amount {
            font-weight: 700; /* Bold */
            color: #1f2937; /* Darker text */
            font-size: 1.1rem; /* Slightly larger for amount */
        }

        #top-spending-table .item-date {
            font-size: 0.75rem; /* Even smaller for date */
            color: #9ca3af; /* Lighter gray */
            white-space: nowrap;
        }

        /* Adjustments for very small screens for top-spending-table */
        @media (max-width: 467px) {
            #top-spending-table tbody tr {
                flex-direction: column; /* Stack items vertically */
                align-items: flex-start; /* Align to left */
                padding: 0.75rem; /* Adjust padding for stacked view */
            }
            #top-spending-table tbody tr td:first-child {
                width: 100%; /* Take full width when stacked */
                flex-basis: auto;
                margin-bottom: 0.5rem; /* Space between icon/details and amount/date */
            }
            #top-spending-table tbody tr td:last-child {
                width: 100%; /* Take full width when stacked */
                flex-basis: auto;
                justify-content: flex-end; /* Keep amount/date aligned right */
            }
            #top-spending-table .item-icon {
                margin-bottom: 0.5rem;
            }
            #top-spending-table .item-amount-date {
                align-self: flex-end; /* Push amount/date to bottom right */
                margin-top: 0; /* Reset margin */
                margin-left: 0; /* Reset margin */
            }
        }
        @media (max-width: 300px) {
            .profile-dropdown-menu {
                min-width: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="container py-8">
        <div class="header-container" data-aos="fade-down">
            <img src="./logo.png" alt="VT Expanse Tracker Logo" class="logo">
        </div>

        <!-- Expense Form -->
        <div class="card" data-aos="fade-up">
            <h2>
                <i class="fas fa-plus-circle mr-2 text-indigo-500"></i> Add New Expense
            </h2>
            <form id="expense-form" class="grid md-grid-cols-2 gap-4">
                <div class="form-field-group">
                    <label for="expense-name" class="text-sm font-medium text-gray-700">Expense Name</label>
                    <input type="text" id="expense-name" name="expenseName" placeholder="Enter the Expanse name"  required>
                </div>
                <div class="form-field-group">
                    <label for="amount" class="text-sm font-medium text-gray-700">Amount (₹)</label>
                    <input type="number" id="amount" name="amount" step="0.01" placeholder="Enter the Amount" required min="0.01">
                </div>
                <div class="form-field-group">
                    <label for="category" class="text-sm font-medium text-gray-700">Category</label>
                    <select id="category" name="category" required>
                        <option value="">Select a category</option>
                        <option value="food">Food</option>
                        <option value="travel">Travel</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="bills">Bills</option>
                        <option value="shopping">Shopping</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-field-group">
                    <label for="date" class="text-sm font-medium text-gray-700">Date</label>
                    <input type="text" id="date" name="date" readonly>
                </div>
                <div class="form-field-group">
                    <label for="week" class="text-sm font-medium text-gray-700">Week</label>
                    <input type="text" id="week" name="week" readonly>
                </div>
                <div class="form-field-group">
                    <label for="month" class="text-sm font-medium text-gray-700">Month</label>
                    <input type="text" id="month" name="month" readonly>
                </div>
                <div class="form-field-group">
                    <label for="year" class="text-sm font-medium text-gray-700">Year</label>
                    <input type="text" id="year" name="year" readonly>
                </div>
                <div class="md-col-span-2 flex-end">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-money-bill-wave mr-2"></i> Add Expense
                    </button>
                </div>
            </form>
        </div>

        <!-- Main Dashboard Tabs -->
        <div class="card tab-buttons-container" data-aos="fade-up">
            <button class="tab-button active" data-tab="dashboard">
                <i class="fas fa-chart-line mr-2"></i> Dashboard
            </button>
            <button class="tab-button" data-tab="history">
                <i class="fas fa-history mr-2"></i> History
            </button>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="tab-content">
            <!-- Dashboard Display Area - Hidden until data is available -->
            <div id="dashboard-display-area" style="display: none;">
                <!-- Expense Tables -->
                <div class="grid lg-grid-cols-2 gap-6">
                    <div class="table-section" data-aos="fade-right">
                        <h2>
                            <i class="fas fa-calendar-day mr-2 text-indigo-500"></i> Daily Expenses (Last 7 Days)
                        </h2>
                        <div class="overflow-x-auto">
                            <table id="daily-expenses-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Amount (₹)</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Daily expenses will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-section" data-aos="fade-left">
                        <h2>
                            <i class="fas fa-calendar-week mr-2 text-indigo-500"></i> Current Week Expenses
                        </h2>
                        <div class="overflow-x-auto">
                            <table id="weekly-expenses-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Amount (₹)</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Weekly expenses will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-section lg-col-span-2" data-aos="fade-up">
                        <h2>
                            <i class="fas fa-calendar-alt mr-2 text-indigo-500"></i> Current Month Expenses
                        </h2>
                        <div class="overflow-x-auto">
                            <table id="monthly-expenses-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Amount (₹)</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Monthly expenses will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Category-Wise Expenses & Top Spending Items -->
                <div class="grid lg-grid-cols-2 gap-6 mt-6">
                    <div class="table-section card" data-aos="fade-right">
                        <h2>
                            <i class="fas fa-tags mr-2 text-indigo-500"></i> Category-Wise Spending (Current Month)
                        </h2>
                        <div class="overflow-x-auto">
                            <table id="category-expenses-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Total Spent (₹)</th>
                                        <th>% of Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Category-wise expenses will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-section" data-aos="fade-left"> <!-- Removed .card from here -->
                        <h2>
                            <i class="fas fa-star mr-2 text-indigo-500"></i> Top Spending Items (Current Month)
                        </h2>
                        <div class="overflow-x-auto">
                            <table id="top-spending-table">
                                <thead>
                                    <tr>
                                        <!-- Headers for Google Pay style are different -->
                                        <th>Transaction</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Top spending items will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Comparison Feature -->
                <div class="card mt-6" data-aos="fade-up">
                    <h2>
                        <i class="fas fa-balance-scale mr-2 text-indigo-500"></i> Spending Comparison
                    </h2>
                    <div id="comparison-results" class="grid md-grid-cols-2 gap-4">
                        <!-- Comparison results will be loaded here -->
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid charts-grid gap-6 mt-6"> <!-- Added charts-grid class -->
                    <div class="chart-item" data-aos="zoom-in">
                        <h2>
                            <i class="fas fa-chart-pie mr-2 text-indigo-500"></i> Monthly Category Distribution
                        </h2>
                        <div class="chart-container">
                            <canvas id="monthlyCategoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-item" data-aos="zoom-in" data-aos-delay="100">
                        <h2>
                            <i class="fas fa-chart-pie mr-2 text-indigo-500"></i> Weekly Category Distribution
                        </h2>
                        <div class="chart-container">
                            <canvas id="weeklyCategoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-item" data-aos="zoom-in" data-aos-delay="200">
                        <h2>
                            <i class="fas fa-chart-bar mr-2 text-indigo-500"></i> Weekly Spending Trend
                        </h2>
                        <div class="chart-container">
                            <canvas id="weeklyTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-item" data-aos="zoom-in" data-aos-delay="300">
                        <h2>
                            <i class="fas fa-chart-line mr-2 text-indigo-500"></i> Monthly Spending Trend
                        </h2>
                        <div class="chart-container">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Content -->
        <div id="history-content" class="tab-content hidden">
            <div class="card" data-aos="fade-up">
                <h2>
                    <i class="fas fa-book mr-2 text-indigo-500"></i> Historical Data
                </h2>
                <div class="mb-4">
                    <label for="history-view-select" class="text-sm font-medium text-gray-700">View History By:</label>
                    <select id="history-view-select" class="md-w-1-2">
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div id="historical-data-display">
                    <!-- Historical data will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Dropdown at the bottom right -->
    <div class="profile-dropdown-container">
        <button id="profileDropdownButton" class="profile-dropdown-button">
            <i class="fas fa-user"></i>
        </button>
        <div id="profileDropdownMenu" class="profile-dropdown-menu">
            <span id="profileUserName" class="profile-name"></span>
            <button class="logout-button" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- PDF Download Message -->
    <div id="pdfDownloadMessage" class="pdf-download-message">
        Generating your monthly report...
    </div>

    <!-- AOS (Animate On Scroll) JS -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800, // animation duration
            once: true, // whether animation should happen only once - while scrolling down
        });

        // Define the base URL for your backend API
        const API_BASE_URL = 'https://vt-wallet.onrender.com/api'; // Make sure this matches your backend server port

        // --- Utility Functions ---

        // Function to handle authenticated API calls with token and retry logic
        async function fetchAuthenticated(url, options = {}, retries = 3, delay = 1000) {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                Swal.fire({
                    icon: 'error',
                    title: 'Authentication Required',
                    text: 'Please log in to access this page.',
                    showConfirmButton: false,
                    timer: 2000
                }).then(() => {
                    window.location.href = '/';
                });
                return new Promise(() => {}); // Prevent further execution
            }

            const authOptions = {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, authOptions);
                    if (response.status === 401) {
                         // Token is expired or invalid, redirect to login
                        Swal.fire({
                            icon: 'warning',
                            title: 'Session Expired',
                            text: 'Your session has expired. Please log in again.',
                            showConfirmButton: false,
                            timer: 2000
                        }).then(() => {
                            localStorage.removeItem('jwtToken');
                            window.location.href = '/';
                        });
                        return new Promise(() => {}); // Prevent further execution
                    }
                    if (!response.ok) {
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay * Math.pow(2, i))); // Exponential backoff
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        console.error(`Fetch failed after ${retries} retries for ${url}:`, error);
                        Swal.fire('Connection Error!', `Could not connect to the backend. Please ensure the server is running at ${API_BASE_URL}.`, 'error');
                        throw error;
                    }
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i))); // Exponential backoff
                }
            }
        }
        
        // Function to decode JWT payload (username, etc.)
        function decodeJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Failed to decode JWT:", e);
                return null;
            }
        }

        // Utility function to get the week number of a date using Luxon
        Date.prototype.getWeek = function() {
            const date = new Date(this.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        };

        async function logout() {
            const { isConfirmed } = await Swal.fire({
                title: 'Are you sure?',
                text: "You will be logged out of your account.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, logout!'
            });

            if (isConfirmed) {
                localStorage.removeItem('jwtToken');
                Swal.fire({
                    icon: 'success',
                    title: 'Logged Out',
                    text: 'You have been successfully logged out.',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    window.location.href = '/'; // Redirect to the authentication page
                });
            }
        }


        // Get elements
        const expenseForm = document.getElementById('expense-form');
        const expenseNameInput = document.getElementById('expense-name');
        const amountInput = document.getElementById('amount');
        const categorySelect = document.getElementById('category');
        const dateInput = document.getElementById('date');
        const weekInput = document.getElementById('week');
        const monthInput = document.getElementById('month');
        const yearInput = document.getElementById('year');
        const profileDropdownButton = document.getElementById('profileDropdownButton');
        const profileDropdownMenu = document.getElementById('profileDropdownMenu');
        const logoutButton = document.getElementById('logoutButton');

        const dailyExpensesTableBody = document.querySelector('#daily-expenses-table tbody');
        const weeklyExpensesTableBody = document.querySelector('#weekly-expenses-table tbody');
        const monthlyExpensesTableBody = document.querySelector('#monthly-expenses-table tbody');
        const categoryExpensesTableBody = document.querySelector('#category-expenses-table tbody');
        const topSpendingTableBody = document.querySelector('#top-spending-table tbody');
        const comparisonResultsDiv = document.getElementById('comparison-results');

        const dashboardContent = document.getElementById('dashboard-content');
        const historyContent = document.getElementById('history-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const historyViewSelect = document.getElementById('history-view-select');
        const historicalDataDisplay = document.getElementById('historical-data-display');
        const pdfDownloadMessage = document.getElementById('pdfDownloadMessage');

        const dashboardDisplayArea = document.getElementById('dashboard-display-area'); // New element

        let expenses = []; // This will store all expenses fetched from the backend
        let monthlyDataForPdf = {}; // Store monthly data for PDF generation

        // Chart instances
        let monthlyCategoryChartInstance;
        let weeklyCategoryChartInstance;
        let weeklyTrendChartInstance;
        let monthlyTrendChartInstance;

        // Map categories to Font Awesome icons for Google Pay style
        const categoryIcons = {
            food: 'fas fa-utensils',
            travel: 'fas fa-plane',
            entertainment: 'fas fa-film',
            bills: 'fas fa-receipt',
            shopping: 'fas fa-shopping-bag',
            other: 'fas fa-ellipsis-h'
        };

        // --- Initialization and Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for JWT on page load
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                 Swal.fire({
                    icon: 'warning',
                    title: 'Authentication Required',
                    text: 'You are not logged in. Redirecting to login page...',
                    showConfirmButton: false,
                    timer: 2000
                }).then(() => {
                    window.location.href = '/';
                });
                return;
            }
            
            // Decode and display username
            const decodedToken = decodeJwt(token);
            if (decodedToken && decodedToken.username) {
                document.getElementById('profileUserName').textContent = decodedToken.username;
            }

            // Set current date, week, month, year in the form using Luxon
            setCurrentDateFields();
            // Load expenses from backend and render dashboard
            await loadAndRenderDashboard();
            // Render historical view
            renderHistoricalView();
            
            // Check if a new month has started for PDF generation
            checkAndGeneratePDF();
        });
        
        // Toggle profile dropdown menu
        profileDropdownButton.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdownMenu.classList.toggle('visible');
        });
        
        // Hide dropdown menu when clicking outside
        window.addEventListener('click', (e) => {
            if (!profileDropdownMenu.contains(e.target) && !profileDropdownButton.contains(e.target)) {
                profileDropdownMenu.classList.remove('visible');
            }
        });
        
        // Attach logout function to the new logout button in the dropdown
        logoutButton.addEventListener('click', logout);


        async function loadAndRenderDashboard() {
            await loadExpenses(); // Load all expenses from backend
            renderDashboard(); // Render all dashboard components based on fetched data

            // Control visibility of dashboard sections based on data
            if (expenses.length > 0) {
                dashboardDisplayArea.style.display = 'block';
            } else {
                dashboardDisplayArea.style.display = 'none';
            }
        }

        // --- Backend API Interaction Functions ---

        async function loadExpenses() {
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses`);
                const data = await response.json();
                expenses = data.map(exp => ({
                    ...exp,
                    date: luxon.DateTime.fromISO(exp.date).toJSDate() // Convert ISO string to JS Date object
                }));
            } catch (error) {
                console.error("Error loading expenses from API:", error);
                // SweetAlert2 error is handled in fetchAuthenticated
            }
        }

        async function addExpense(expenseData) {
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });
                const addedExpense = await response.json();
                console.log('Expense added:', addedExpense);
                await loadAndRenderDashboard(); // Reload and re-render all data
                expenseForm.reset();
                setCurrentDateFields();
                Swal.fire('Success!', 'Expense added successfully!', 'success'); // Success alert
            } catch (error) {
                console.error('Error adding expense:', error);
                Swal.fire('Error!', 'Failed to add expense. Please try again.', 'error'); // Using SweetAlert2
            }
        }

        async function deleteHistoricalPeriodFromBackend(id, type) {
            const { isConfirmed } = await Swal.fire({
                title: 'Are you sure?',
                text: `You are about to delete all expenses for ${id}. This action cannot be undone!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            });

            if (isConfirmed) {
                try {
                    const response = await fetchAuthenticated(`${API_BASE_URL}/history/${type}/${id}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    console.log(result.message);
                    // Only re-render history view if the deletion was successful
                    renderHistoricalView();
                    // Re-fetch and re-render dashboard data if needed (e.g., if current week/month was deleted)
                    await loadAndRenderDashboard();
                    Swal.fire('Deleted!', 'Your history has been deleted.', 'success'); // Success alert
                } catch (error) {
                    console.error('Error deleting historical period:', error);
                    Swal.fire('Error!', 'Failed to delete history. Please try again.', 'error'); // Error alert
                }
            }
        }

        // --- Date and Time Utilities using Luxon ---
        function getFormattedDate(date) {
            // Format to DD/MM/YYYY
            return luxon.DateTime.fromJSDate(date).toFormat('dd/MM/yyyy');
        }

        function getMonthName(date) {
            return luxon.DateTime.fromJSDate(date).toFormat('LLLL');
        }

        function getWeekIdentifier(date) {
            const dt = luxon.DateTime.fromJSDate(date);
            // Luxon's week number (ISO week) is generally reliable
            return `${dt.weekYear}-W${dt.weekNumber}`;
        };

        function setCurrentDateFields() {
            const today = luxon.DateTime.local();
            dateInput.value = today.toFormat('dd/MM/yyyy'); // Format for form
            weekInput.value = `Week ${today.weekNumber} (${today.year})`;
            monthInput.value = today.toFormat('LLLL');
            yearInput.value = today.year;
        }
        
        // --- PDF Generation Logic ---
        async function generateMonthlyPDF() {
            const today = luxon.DateTime.local();
            const lastMonth = today.minus({ months: 1 });
            const lastMonthName = lastMonth.toFormat('LLLL');
            const lastYear = lastMonth.year;
            
            const pdfId = `monthly-report-${lastMonthName}-${lastYear}`;
            if (localStorage.getItem(pdfId)) {
                return; // PDF already generated for this month
            }
            
            pdfDownloadMessage.classList.add('show');
            
            // Fetch data for the PDF
            let lastMonthExpenses = [];
            let lastMonthCategorySummary = [];
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/monthly`);
                lastMonthExpenses = await response.json();
                const categoryResponse = await fetchAuthenticated(`${API_BASE_URL}/expenses/category-summary`);
                lastMonthCategorySummary = await categoryResponse.json();
            } catch (error) {
                console.error("Failed to fetch data for PDF:", error);
                pdfDownloadMessage.classList.remove('show');
                return;
            }
            
            const totalSpending = lastMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            // Create a temporary container to hold the content for the PDF
            const pdfContent = document.createElement('div');
            pdfContent.style.width = '794px'; // A4 width in pixels
            pdfContent.style.padding = '30px';
            pdfContent.style.boxSizing = 'border-box';
            pdfContent.style.backgroundColor = '#fff';
            
            // Add report title and summary
            let reportHtml = `
                <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                    <img src="./logo.png" alt="VT Expanse Tracker Logo" style="max-width: 200px;">
                </div>
                <h1 style="text-align: center; color: #4338ca;">Monthly Expense Report</h1>
                <h3 style="text-align: center;">${lastMonthName} ${lastYear}</h3>
                <p style="text-align: center;">Total Spending: ₹${totalSpending.toFixed(2)}</p>
                <hr style="margin: 1.5rem 0; border: 1px solid #e5e7eb;">
            `;
            
            // Add category-wise spending table
            reportHtml += `
                <div style="margin-top: 2rem;">
                    <h4>Category-wise Spending:</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #ccc;">Category</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #ccc;">Total Spent (₹)</th>
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 1px solid #ccc;">% of Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${lastMonthCategorySummary.map(item => `
                                <tr>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">₹${item.totalSpent.toFixed(2)}</td>
                                    <td style="padding: 0.5rem; border-bottom: 1px solid #eee;">${item.percentage}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            pdfContent.innerHTML = reportHtml;

            // Generate PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');
            
            doc.html(pdfContent, {
                callback: function (doc) {
                    doc.save(`Expense_Report_${lastMonthName}_${lastYear}.pdf`);
                    localStorage.setItem(pdfId, 'true'); // Set flag to prevent future generation
                    pdfDownloadMessage.classList.remove('show');
                    Swal.fire('Success', `Monthly report for ${lastMonthName} has been generated!`, 'success');
                },
                x: 10,
                y: 10
            });
        }
        
        async function checkAndGeneratePDF() {
            const today = luxon.DateTime.local();
            // Check if it's the 1st of the month
            if (today.day === 1) {
                 const lastMonth = today.minus({ months: 1 });
                 const pdfId = `monthly-report-${lastMonth.toFormat('LLLL')}-${lastMonth.year}`;
                 // Check if the report has already been generated
                 if (!localStorage.getItem(pdfId)) {
                    await generateMonthlyPDF();
                 }
            }
        }


        // --- Expense Form Submission ---
        expenseForm.addEventListener('submit', (e) => {
            e.preventDefault();

            // Create a Luxon DateTime object from the user-friendly format
            const dateLuxon = luxon.DateTime.fromFormat(dateInput.value, 'dd/MM/yyyy');
            
            if (!dateLuxon.isValid) {
                Swal.fire('Error', 'Invalid date format. Please refresh the page.', 'error');
                return;
            }

            const newExpense = {
                name: expenseNameInput.value,
                amount: parseFloat(amountInput.value),
                category: categorySelect.value,
                // Send ISO string for backend storage
                date: dateLuxon.toISO(), 
                // These should be formatted to match the backend model's requirements
                week: `Week ${dateLuxon.weekNumber} (${dateLuxon.year})`,
                month: dateLuxon.toFormat('LLLL'),
                year: dateLuxon.year
            };

            addExpense(newExpense);
        });

        // --- Rendering Functions ---
        async function renderDashboard() {
            renderDailyExpenses();
            renderWeeklyExpenses();
            renderMonthlyExpenses();
            renderCategoryWiseExpenses();
            renderTopSpendingItems();
            renderComparison();
            renderCharts();
        }

        async function renderDailyExpenses() {
            dailyExpensesTableBody.innerHTML = '';
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/daily`);
                const recentExpenses = await response.json();
                recentExpenses.forEach(exp => {
                    const row = dailyExpensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${luxon.DateTime.fromISO(exp.date).toFormat('dd/MM/yyyy')}</td>
                        <td>${exp.name}</td>
                        <td>₹${exp.amount.toFixed(2)}</td>
                        <td>${exp.category.charAt(0).toUpperCase() + exp.category.slice(1)}</td>
                    `;
                });
            } catch (error) {
                console.error('Error rendering daily expenses:', error);
            }
        }

        async function renderWeeklyExpenses() {
            weeklyExpensesTableBody.innerHTML = '';
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/weekly`);
                const currentWeekExpenses = await response.json();
                currentWeekExpenses.forEach(exp => {
                    const row = weeklyExpensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${luxon.DateTime.fromISO(exp.date).toFormat('dd/MM/yyyy')}</td>
                        <td>${exp.name}</td>
                        <td>₹${exp.amount.toFixed(2)}</td>
                        <td>${exp.category.charAt(0).toUpperCase() + exp.category.slice(1)}</td>
                    `;
                });
            } catch (error) {
                console.error('Error rendering weekly expenses:', error);
            }
        }

        async function renderMonthlyExpenses() {
            monthlyExpensesTableBody.innerHTML = '';
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/monthly`);
                const currentMonthExpenses = await response.json();
                monthlyDataForPdf.monthlyExpenses = currentMonthExpenses; // Save for PDF
                currentMonthExpenses.forEach(exp => {
                    const row = monthlyExpensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${luxon.DateTime.fromISO(exp.date).toFormat('dd/MM/yyyy')}</td>
                        <td>${exp.name}</td>
                        <td>₹${exp.amount.toFixed(2)}</td>
                        <td>${exp.category.charAt(0).toUpperCase() + exp.category.slice(1)}</td>
                    `;
                });
            } catch (error) {
                console.error('Error rendering monthly expenses:', error);
            }
        }

        async function renderCategoryWiseExpenses() {
            categoryExpensesTableBody.innerHTML = '';
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/category-summary`);
                const categorySummary = await response.json();
                monthlyDataForPdf.categorySummary = categorySummary; // Save for PDF
                categorySummary.forEach(item => {
                    const row = categoryExpensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</td>
                        <td>₹${item.totalSpent.toFixed(2)}</td>
                        <td>${item.percentage}%</td>
                    `;
                });
            } catch (error) {
                console.error('Error rendering category-wise expenses:', error);
            }
        }

        async function renderTopSpendingItems() {
            topSpendingTableBody.innerHTML = '';
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/top-spending`);
                const top10Items = await response.json();
                top10Items.forEach(exp => {
                    const row = topSpendingTableBody.insertRow();
                    // Google Pay style layout
                    row.innerHTML = `
                        <td>
                            <div class="item-icon">
                                <i class="${categoryIcons[exp.category] || categoryIcons.other}"></i>
                            </div>
                            <div class="item-details">
                                <div class="item-name">${exp.name}</div>
                                <div class="item-category">${exp.category.charAt(0).toUpperCase() + exp.category.slice(1)}</div>
                            </div>
                        </td>
                        <td>
                            <div class="item-amount-date">
                                <div class="item-amount">₹${exp.amount.toFixed(2)}</div>
                                <div class="item-date">${luxon.DateTime.fromISO(exp.date).toFormat('dd/MM/yyyy')}</div>
                            </div>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error rendering top spending items:', error);
            }
        }

        async function renderComparison() {
            comparisonResultsDiv.innerHTML = '';

            const today = luxon.DateTime.local();
            const currentMonth = today.month;
            const currentYear = today.year;

            const prevMonthDT = today.minus({ months: 1 });
            const prevMonthName = prevMonthDT.toFormat('LLLL');
            const prevYear = prevMonthDT.year;

            let currentMonthExpenses = [];
            let prevMonthExpenses = [];

            try {
                const currentMonthResponse = await fetchAuthenticated(`${API_BASE_URL}/expenses/monthly`);
                currentMonthExpenses = await currentMonthResponse.json();

                prevMonthExpenses = expenses.filter(exp =>
                    luxon.DateTime.fromJSDate(exp.date).month === prevMonthDT.month && luxon.DateTime.fromJSDate(exp.date).year === prevYear
                );
            } catch (error) {
                console.error('Error fetching data for comparison:', error);
            }

            const currentMonthTotal = currentMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const prevMonthTotal = prevMonthExpenses.reduce((sum, exp) => sum + exp.amount, 0);

            let overallComparisonText = '';
            if (currentMonthTotal > prevMonthTotal) {
                const diff = (currentMonthTotal - prevMonthTotal).toFixed(2);
                overallComparisonText = `<p class="text-red-600 font-semibold">You spent ₹${diff} more this month than last month.</p>`;
            } else if (currentMonthTotal < prevMonthTotal) {
                const diff = (prevMonthTotal - currentMonthTotal).toFixed(2);
                overallComparisonText = `<p class="text-green-600 font-semibold">You spent ₹${diff} less this month than last month!</p>`;
            } else {
                overallComparisonText = `<p class="text-gray-600 font-semibold">Your spending this month is the same as last month.</p>`;
            }

            const currentCategories = {};
            currentMonthExpenses.forEach(exp => {
                if (!currentCategories[exp.category]) currentCategories[exp.category] = 0;
                currentCategories[exp.category] += exp.amount;
            });

            const prevCategories = {};
            prevMonthExpenses.forEach(exp => {
                if (!prevCategories[exp.category]) prevCategories[exp.category] = 0;
                prevCategories[exp.category] += exp.amount;
            });

            let categoryComparisonHtml = '<h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2 md-col-span-2">Category-wise Comparison:</h3>';
            categoryComparisonHtml += '<div class="md-col-span-2 overflow-x-auto"><table class="w-full text-sm">';
            categoryComparisonHtml += '<thead><tr><th>Category</th><th>Current Month</th><th>Previous Month</th><th>Change</th></tr></thead><tbody>';

            const allCategories = new Set([...Object.keys(currentCategories), ...Object.keys(prevCategories)]);

            allCategories.forEach(category => {
                const currentCatTotal = currentCategories[category] || 0;
                const prevCatTotal = prevCategories[category] || 0;
                const change = currentCatTotal - prevCatTotal;
                const changeText = change > 0 ? `+₹${change.toFixed(2)}` : (change < 0 ? `-₹${Math.abs(change).toFixed(2)}` : '₹0.00');
                const changeColor = change > 0 ? 'text-red-500' : (change < 0 ? 'text-green-500' : 'text-gray-500');

                categoryComparisonHtml += `
                    <tr>
                        <td>${category.charAt(0).toUpperCase() + category.slice(1)}</td>
                        <td>₹${currentCatTotal.toFixed(2)}</td>
                        <td>₹${prevCatTotal.toFixed(2)}</td>
                        <td class="${changeColor}">${changeText}</td>
                    </tr>
                `;
            });
            categoryComparisonHtml += '</tbody></table></div>';

            comparisonResultsDiv.innerHTML = `
                <div class="md-col-span-2">
                    <p class="text-gray-600"><strong>Total Spending:</strong></p>
                    <p>Current Month (${luxon.DateTime.fromJSDate(today).toFormat('LLLL')} ${currentYear}): <strong>₹${currentMonthTotal.toFixed(2)}</strong></p>
                    <p>Previous Month (${prevMonthName} ${prevYear}): <strong>₹${prevMonthTotal.toFixed(2)}</strong></p>
                    ${overallComparisonText}
                </div>
                ${categoryComparisonHtml}
            `;
        }

        async function renderCharts() {
            // Destroy existing chart instances if they exist
            if (monthlyCategoryChartInstance) {
                monthlyCategoryChartInstance.destroy();
            }
            if (weeklyCategoryChartInstance) {
                weeklyCategoryChartInstance.destroy();
            }
            if (weeklyTrendChartInstance) {
                weeklyTrendChartInstance.destroy();
            }
            if (monthlyTrendChartInstance) {
                monthlyTrendChartInstance.destroy();
            }

            // --- Monthly Category Distribution Pie Chart ---
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/expenses/category-summary`);
                const categorySummary = await response.json();

                const pieChartLabels = categorySummary.map(item => item.category.charAt(0).toUpperCase() + item.category.slice(1));
                const pieChartData = categorySummary.map(item => item.totalSpent);
                const pieChartColors = [
                    '#4f46e5', '#818cf8', '#a78bfa', '#c4b5fd', '#e0e7ff', '#6366f1', '#a5b4fc', '#c7d2fe', '#ddd6fe', '#f0f9ff'
                ]; // Various shades of indigo/purple

                const monthlyCategoryCtx = document.getElementById('monthlyCategoryChart').getContext('2d');
                monthlyCategoryChartInstance = new Chart(monthlyCategoryCtx, {
                    type: 'pie',
                    data: {
                        labels: pieChartLabels,
                        datasets: [{
                            data: pieChartData,
                            backgroundColor: pieChartColors.slice(0, pieChartLabels.length),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `Monthly Spending by Category (${luxon.DateTime.local().toFormat('LLLL')} ${luxon.DateTime.local().year})`,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering monthly category chart:', error);
            }

            // --- Weekly Category Distribution Pie Chart ---
            try {
                const currentWeekIdentifier = luxon.DateTime.local().toFormat('yyyy-Www');
                const currentWeekExpenses = expenses.filter(exp => luxon.DateTime.fromJSDate(exp.date).toFormat('yyyy-Www') === currentWeekIdentifier);

                const weeklyCategoryTotals = {};
                currentWeekExpenses.forEach(exp => {
                    if (!weeklyCategoryTotals[exp.category]) {
                        weeklyCategoryTotals[exp.category] = 0;
                    }
                    weeklyCategoryTotals[exp.category] += exp.amount;
                });

                const weeklyPieChartLabels = Object.keys(weeklyCategoryTotals).map(cat => cat.charAt(0).toUpperCase() + cat.slice(1));
                const weeklyPieChartData = Object.values(weeklyCategoryTotals);
                const weeklyPieChartColors = [
                    '#10b981', '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5', '#059669', '#047857', '#064e3b', '#022c22', '#001a14'
                ]; // Various shades of green

                const weeklyCategoryCtx = document.getElementById('weeklyCategoryChart').getContext('2d');
                weeklyCategoryChartInstance = new Chart(weeklyCategoryCtx, {
                    type: 'pie',
                    data: {
                        labels: weeklyPieChartLabels,
                        datasets: [{
                            data: weeklyPieChartData,
                            backgroundColor: weeklyPieChartColors.slice(0, weeklyPieChartLabels.length),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: `Weekly Spending by Category (Week ${luxon.DateTime.local().weekNumber})`,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering weekly category chart:', error);
            }

            // --- Weekly Spending Trend Bar Chart ---
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/history/weekly`);
                const weeklyHistory = await response.json();

                const weeklySpending = {};
                weeklyHistory.forEach(period => {
                    weeklySpending[period.weekId] = period.totalSpent;
                });

                const sortedWeekIds = Object.keys(weeklySpending).sort((a, b) => {
                    const dtA = luxon.DateTime.fromFormat(a, 'yyyy-Www');
                    const dtB = luxon.DateTime.fromFormat(b, 'yyyy-Www');
                    return dtA.toMillis() - dtB.toMillis();
                });

                const last10Weeks = sortedWeekIds.slice(-10); // Limit to last 10 weeks
                const trendChartLabels = last10Weeks.map(weekId => {
                    const dt = luxon.DateTime.fromFormat(weekId, 'yyyy-Www');
                    return `Week ${dt.weekNumber} (${dt.weekYear})`;
                });
                const trendChartData = last10Weeks.map(weekId => weeklySpending[weekId]);

                const weeklyTrendCtx = document.getElementById('weeklyTrendChart').getContext('2d');
                weeklyTrendChartInstance = new Chart(weeklyTrendCtx, {
                    type: 'bar',
                    data: {
                        labels: trendChartLabels,
                        datasets: [{
                            label: 'Total Spending (₹)',
                            data: trendChartData,
                            backgroundColor: 'rgba(79, 70, 229, 0.8)',
                            borderColor: '#4f46e5',
                            borderWidth: 1,
                            borderRadius: 5,
                            hoverBackgroundColor: '#4338ca'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: 'Weekly Spending Trend',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Amount (₹)',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Week',
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering weekly trend chart:', error);
            }

            // --- Monthly Spending Trend Bar Chart ---
            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/history/monthly`);
                const monthlyHistory = await response.json();

                const monthlySpending = {};
                monthlyHistory.forEach(period => {
                    monthlySpending[period.monthId] = period.totalSpent;
                });

                const sortedMonthYearIds = Object.keys(monthlySpending).sort((a, b) => {
                    const dtA = luxon.DateTime.fromFormat(a, 'LLLL yyyy');
                    const dtB = luxon.DateTime.fromFormat(b, 'LLLL yyyy');
                    return dtA.toMillis() - dtB.toMillis();
                });

                const last12Months = sortedMonthYearIds.slice(-12); // Limit to last 12 months
                const monthlyTrendChartLabels = last12Months;
                const monthlyTrendChartData = last12Months.map(monthYearId => monthlySpending[monthYearId]);

                const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
                monthlyTrendChartInstance = new Chart(monthlyTrendCtx, {
                    type: 'bar',
                    data: {
                        labels: monthlyTrendChartLabels,
                        datasets: [{
                            label: 'Total Spending (₹)',
                            data: monthlyTrendChartData,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            borderRadius: 5,
                            hoverBackgroundColor: '#dc2626'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: 'Monthly Spending Trend',
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                color: '#374151'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Amount (₹)',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month',
                                    font: {
                                        size: 14
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering monthly trend chart:', error);
            }
        }

        // --- History Page Logic ---
        tabButtons.forEach(button => {
            button.addEventListener('click', async () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                if (button.dataset.tab === 'dashboard') {
                    dashboardContent.classList.remove('hidden');
                    historyContent.classList.add('hidden');
                    await loadAndRenderDashboard(); // Reload and re-render dashboard when switching back
                } else {
                    dashboardContent.classList.add('hidden');
                    historyContent.classList.remove('hidden');
                    renderHistoricalView(); // Render history when switching
                }
            });
        });

        historyViewSelect.addEventListener('change', renderHistoricalView);

        async function renderHistoricalView() {
            historicalDataDisplay.innerHTML = '';
            const viewType = historyViewSelect.value; // 'weekly' or 'monthly'

            try {
                const response = await fetchAuthenticated(`${API_BASE_URL}/history/${viewType}`);
                const historicalPeriods = await response.json();

                // Sort the periods to ensure newest first
                let sortedPeriods = [];
                if (viewType === 'weekly') {
                    sortedPeriods = historicalPeriods.sort((a, b) => {
                        const dtA = luxon.DateTime.fromFormat(a.weekId, 'yyyy-Www');
                        const dtB = luxon.DateTime.fromFormat(b.weekId, 'yyyy-Www');
                        return dtB.toMillis() - dtA.toMillis(); // Descending order
                    });
                } else { // monthly
                    sortedPeriods = historicalPeriods.sort((a, b) => {
                        const dtA = luxon.DateTime.fromFormat(a.monthId, 'LLLL yyyy');
                        const dtB = luxon.DateTime.fromFormat(b.monthId, 'LLLL yyyy');
                        return dtB.toMillis() - dtA.toMillis(); // Descending order
                    });
                }


                sortedPeriods.forEach(period => {
                    const periodId = period.weekId || period.monthId; // Use the correct ID for the period
                    const totalSpend = period.totalSpent;
                    const periodExpenses = period.expenses; // Array of expenses for this period

                    const periodDiv = document.createElement('div');
                    periodDiv.className = 'card mb-4'; /* Kept card for history individual sections */
                    periodDiv.innerHTML = `
                        <div class="flex-between mb-2">
                            <h3 class="text-xl font-semibold text-gray-800">${periodId} (Total: ₹${totalSpend.toFixed(2)})</h3>
                            <button class="btn-danger delete-history-btn" data-id="${periodId}" data-type="${viewType}">
                                <i class="fas fa-trash-alt mr-1"></i> Delete ${viewType === 'weekly' ? 'Week' : 'Month'}
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Name</th>
                                        <th>Amount (₹)</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${periodExpenses.map(exp => `
                                        <tr>
                                            <td>${luxon.DateTime.fromISO(exp.date).toFormat('dd/MM/yyyy')}</td>
                                            <td>${exp.name}</td>
                                            <td>₹${exp.amount.toFixed(2)}</td>
                                            <td>${exp.category.charAt(0).toUpperCase() + exp.category.slice(1)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    historicalDataDisplay.appendChild(periodDiv);
                });
            } catch (error) {
                console.error('Error rendering historical view:', error);
            }

            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-history-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const idToDelete = e.target.dataset.id;
                    const typeToDelete = e.target.dataset.type;
                    // Call the SweetAlert2-integrated delete function
                    deleteHistoricalPeriodFromBackend(idToDelete, typeToDelete);
                });
            });
        }
    </script>
</body>
</html>
